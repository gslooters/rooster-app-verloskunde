# DRAAD-204: FASE 1 TECHNICAL DETAILS

**Versie:** 1.0  
**Datum:** 2025-12-17 22:20 CET

---

## üó£Ô∏è REQUEST-RESPONSE SPECIFICATION

### **Backend API Endpoint**

```
POST /api/roster/solve
```

### **Request Body**

```json
{
  "roster_id": "550e8400-e29b-41d4-a716-446655440000"
}
```

**Validatie:**
- `roster_id` is required (uuid)
- Must be string format

### **Response (Success - HTTP 200)**

```json
{
  "success": true,
  "roster_id": "550e8400-e29b-41d4-a716-446655440000",
  "message": "Greedy is aan het werk... Updates volgen live via Supabase realtime",
  "greedy_status": "running",
  "frontend_instructions": {
    "subscribe_to": "roster_assignments",
    "filter_by": {
      "roster_id": "550e8400-e29b-41d4-a716-446655440000"
    },
    "events": ["UPDATE", "INSERT"],
    "description": "Watch live as Greedy assigns shifts to employees"
  },
  "architecture": {
    "model": "self-service",
    "backend_role": "routing only",
    "greedy_role": "autonomous (fetches data, runs algorithm, writes DB)",
    "frontend_role": "realtime monitoring via subscription"
  },
  "draad204": {
    "status": "IMPLEMENTED",
    "version": "1.0-FASE1",
    "endpoint": "https://greedy-production.up.railway.app/api/greedy/solve",
    "timeout_ms": 30000,
    "payload_size": "minimal (roster_id + credentials only)",
    "backend_data_fetching": "REMOVED",
    "backend_update_loop": "REMOVED",
    "async_processing": true,
    "greedy_autonomous": true
  },
  "total_time_ms": 245
}
```

### **Response (Error - HTTP 400/404/500)**

#### Missing roster_id (HTTP 400)
```json
{
  "error": "roster_id is verplicht"
}
```

#### Roster not found (HTTP 404)
```json
{
  "error": "Roster niet gevonden"
}
```

#### Invalid date range (HTTP 400)
```json
{
  "error": "Roster heeft geen geldige begindatum of einddatum"
}
```

#### Invalid status (HTTP 400)
```json
{
  "error": "Roster status is 'confirmed', moet 'draft' zijn"
}
```

#### Server error (HTTP 500)
```json
{
  "error": "Internal server error",
  "message": "[specific error message]"
}
```

---

## üó£Ô∏è GREEDY REQUEST SPECIFICATION

### **Greedy HTTP POST**

```
POST https://greedy-production.up.railway.app/api/greedy/solve
Content-Type: application/json
User-Agent: rooster-app-verloskunde/DRAAD-204

Body:
{
  "roster_id": "550e8400-e29b-41d4-a716-446655440000",
  "supabase_url": "https://rzecogncpkjfytebfkni.supabase.co",
  "supabase_key": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

**Field Details:**
- `roster_id` (string, uuid)
- `supabase_url` (string, https URL)
- `supabase_key` (string, JWT service role key)

**Size:** ~300-500 bytes (minimal!)

### **Greedy HTTP Timeout**

```typescript
GREEDY_TIMEOUT = 30000ms (default)
```

If timeout, backend returns error but doesn't wait for Greedy.

---

## üó£Ô∏è DATABASE SCHEMA VALIDATION

### **Table: roosters**

| Field | Type | Validated | Usage |
|-------|------|-----------|-------|
| id | uuid | Primary key | Fetch & filter |
| start_date | date | Required | Passed to Greedy |
| end_date | date | Required | Passed to Greedy |
| status | text | MUST='draft' | Enforce constraint |
| created_at | timestamp | - | - |
| updated_at | timestamp | Updated async | Status change |

**Validation Logic (Backend Fase 1):**
```typescript
// Query
const { data: roster, error: rosterError } = await supabase
  .from('roosters')
  .select('id, start_date, end_date, status')
  .eq('id', roster_id)
  .single();

// Checks
if (rosterError || !roster) {
  return { error: 'Roster niet gevonden' };
}

if (!roster.start_date || !roster.end_date) {
  return { error: 'Roster heeft geen geldige begindatum of einddatum' };
}

if (roster.status !== 'draft') {
  return { error: `Roster status is '${roster.status}', moet 'draft' zijn` };
}
```

### **Table: roster_assignments**

| Field | Type | Set By | Notes |
|-------|------|--------|-------|
| id | uuid | Greedy | Primary key (already created) |
| roster_id | uuid | Greedy | Filter: WHERE roster_id=X |
| employee_id | text | Greedy | Employee ID (string format) |
| date | date | Greedy | Assignment date |
| dagdeel | text | Greedy | 'O' \| 'M' \| 'A' (strict literal) |
| service_id | uuid | Greedy | Service type UUID |
| status | integer | Greedy | 1 = assigned, 0 = unassigned |
| source | text | Greedy | MUST='greedy' |
| ort_run_id | uuid | Greedy | Batch tracking ID |
| ort_confidence | numeric | Greedy | Confidence score (optional) |
| created_at | timestamp | Auto | Auto-set on INSERT |
| updated_at | timestamp | Auto | Auto-set on UPDATE |
| notes | text | Greedy | Optional notes (optional) |
| blocked_by_date | date | - | Not set by Greedy |
| blocked_by_dagdeel | text | - | Not set by Greedy |
| blocked_by_service_id | uuid | - | Not set by Greedy |
| is_protected | boolean | - | Not set by Greedy |
| constraint_reason | jsonb | - | Not set by Greedy |
| previous_service_id | uuid | - | Not set by Greedy |

**DRAAD-204 Greedy UPDATE Query Pattern:**
```typescript
// Greedy will do:
await supabase
  .from('roster_assignments')
  .update({
    service_id: service.id,
    employee_id: employee.id,
    status: 1,
    source: 'greedy',
    ort_run_id: currentRunId
  })
  .eq('id', assignmentId);
```

**Key Points:**
- ‚úÖ Only UPDATE, no INSERT/UPSERT
- ‚úÖ DRAAD-155 pattern maintained
- ‚úÖ source='greedy' for identification
- ‚úÖ ort_run_id for batch tracking
- ‚úÖ dagdeel strict: 'O', 'M', 'A' (NOT numbers/lowercase)

### **Table: employees**

| Field | Type | Notes |
|-------|------|-------|
| id | text | Primary key (employee ID) |
| voornaam | text | First name |
| achternaam | text | Last name |
| email | text | Email |
| telefoon | text | Phone |
| actief | boolean | Must be true |
| dienstverband | text | Employment type |
| team | text | Team assignment |
| aantalwerkdagen | integer | Scheduled work days |
| roostervrijdagen | ARRAY | Days off (array format) |
| structureel_nbh | jsonb | Structural night requirements |
| created_at | timestamp | Created date |
| updated_at | timestamp | Updated date |

**Greedy will fetch:** All actief=true employees

### **Table: service_types**

| Field | Type | Notes |
|-------|------|-------|
| id | uuid | Primary key |
| code | text | Service code (e.g., 'O1', 'M1', 'A1') |
| naam | text | Service name |
| beschrijving | text | Description |
| begintijd | text | Start time (HH:MM format) |
| eindtijd | text | End time (HH:MM format) |
| duur | numeric | Duration |
| kleur | text | Color for UI |
| dienstwaarde | numeric | Service value |
| actief | boolean | Must be true |
| planregels | text | Planning rules |
| blokkeert_volgdag | boolean | Blocks next day |
| team_groen_regels | jsonb | Green team rules |
| team_oranje_regels | jsonb | Orange team rules |
| team_totaal_regels | jsonb | Total team rules |
| is_system | boolean | System service flag |
| created_at | timestamp | Created date |
| updated_at | timestamp | Updated date |

**Greedy will fetch:** All actief=true services

### **Table: employee_services**

| Field | Type | Notes |
|-------|------|-------|
| id | uuid | Primary key |
| service_id | uuid | FK: service_types.id |
| employee_id | text | FK: employees.id |
| aantal | integer | Number of shifts needed |
| actief | boolean | Must be true |
| created_at | timestamp | Created date |
| updated_at | timestamp | Updated date |

**Greedy will fetch:** All actief=true employee_services

### **Table: roster_employee_services**

| Field | Type | Notes |
|-------|------|-------|
| id | uuid | Primary key |
| roster_id | uuid | FK: roosters.id |
| employee_id | text | FK: employees.id |
| service_id | uuid | FK: service_types.id |
| aantal | integer | Number of shifts needed |
| actief | boolean | Must be true |
| created_at | timestamp | Created date |
| updated_at | timestamp | Updated date |

**Greedy will fetch:** For specific roster_id

### **Table: roster_period_staffing_dagdelen**

| Field | Type | Notes |
|-------|------|-------|
| id | uuid | Primary key |
| roster_id | uuid | FK: roosters.id |
| date | date | Assignment date |
| dagdeel | text | 'O' \| 'M' \| 'A' |
| service_id | uuid | FK: service_types.id |
| team | text | Team requirement |
| status | text | Status |
| aantal | integer | Number needed |
| invulling | integer | Filled count |
| created_at | timestamp | Created date |
| updated_at | timestamp | Updated date |

**Greedy will fetch:** For date/dagdeel/roster

---

## üëÄ DAGDEEL TYPE STRICTNESS (DRAAD-202 Fix)

### **What is dagdeel?**

Dagdeel = Part of day:
- `'O'` = Ochtend (Morning, ~7:00-13:00)
- `'M'` = Middag (Afternoon, ~13:00-19:00)
- `'A'` = Avond (Evening, ~19:00-23:30)

### **STRICT TYPE ENFORCEMENT**

```typescript
// ‚ùå WRONG: Allow any string
type Dagdeel = string;

// ‚ùå WRONG: Allow numbers
type Dagdeel = 0 | 1 | 2;

// ‚úÖ CORRECT: Strict literals (DRAAD-202 fix)
type Dagdeel = 'O' | 'M' | 'A';

// ‚úÖ CORRECT: Branded type
type StrictDagdeel = 'O' | 'M' | 'A' & { readonly __brand: 'dagdeel' };
```

**Validation in Greedy:**
```python
DAGDEELS = ['O', 'M', 'A']

if dagdeel not in DAGDEELS:
    raise ValueError(f'Invalid dagdeel: {dagdeel}')
```

---

## üó£Ô∏è SOURCE FIELD ENUMERATION (DRAAD-155 Pattern)

### **Valid Values**

```typescript
type SourceType = 'greedy' | 'manual' | 'fixed' | 'suggested';
```

### **DRAAD-204 Requirement**

- Greedy will set: `source='greedy'`
- No other sources in Fase 1
- Backend doesn't set source

---

## üó£Ô∏è STATUS FIELD (Assignment Status)

### **Valid Values**

```typescript
type AssignmentStatus = 0 | 1;
// 0 = unassigned/draft
// 1 = assigned/confirmed
```

### **DRAAD-204 Requirement**

- Greedy sets: `status=1` for assigned
- DB pre-creates rows with status=0
- Greedy only does UPDATE (status: 0 -> 1)

---

## üëç ENVIRONMENT VARIABLES

### **Backend Configuration**

```bash
# Supabase Connection
SUPABASE_URL=https://rzecogncpkjfytebfkni.supabase.co
SUPABASE_ANON_KEY=eyJhbGc...[frontend key]...oI1A
SUPABASE_SERVICE_ROLE_KEY=eyJhbGc...[backend key]...oI1A

# Greedy Microservice
GREEDY_ENDPOINT=https://greedy-production.up.railway.app/api/greedy/solve
GREEDY_TIMEOUT=30000
```

### **Frontend Configuration**

```bash
# Via .env.local (public)
NEXT_PUBLIC_SUPABASE_URL=https://rzecogncpkjfytebfkni.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGc...[frontend key]...
```

### **Greedy Configuration**

Greedy receives credentials in request body (no .env needed for DB connection)

---

## üîç ERROR CODES & MESSAGES (Dutch)

| HTTP | Error | Dutch Message |
|------|-------|---------------|
| 400 | Missing roster_id | "roster_id is verplicht" |
| 404 | Roster not found | "Roster niet gevonden" |
| 400 | Invalid dates | "Roster heeft geen geldige begindatum of einddatum" |
| 400 | Invalid status | "Roster status is '...', moet 'draft' zijn" |
| 500 | Missing Supabase creds | "Server configuration error: missing Supabase credentials" |
| 500 | Greedy request failed | "Roostering kon niet worden gestart" |
| 500 | Internal error | "Internal server error" |

---

## üìÑ LOGGING (DRAAD-202 Style)

### **Logging Prefix**

```typescript
console.log('[DRAAD-204] ...');
console.error('[DRAAD-204] ‚ùå ...');
console.warn('[DRAAD-204] ‚ö†Ô∏è  ...');
```

### **Key Log Points**

```typescript
// Startup
[DRAAD-204] ========== POST /api/roster/solve (SELF-SERVICE) ==========
[DRAAD-204] Roster ID: 550e8400-e29b-41d4-a716-446655440000

// Validation
[DRAAD-204] === PHASE 1: VALIDATION ===
[DRAAD-204] ‚úÖ Roster validation passed

// Request build
[DRAAD-204] === PHASE 2: BUILD GREEDY REQUEST ===
[DRAAD-204] ‚úÖ Greedy request built (minimal)

// Send
[DRAAD-204] === PHASE 3: SEND TO GREEDY ===
[DRAAD-204] Endpoint: https://greedy-production.up.railway.app/api/greedy/solve
[DRAAD-204] ‚úÖ Greedy request sent successfully (async)

// Response
[DRAAD-204] === PHASE 4: IMMEDIATE RESPONSE ===
[DRAAD-204] ========== SUCCESS ==========
```

---

## üóíÔ∏è NOTES

- **No breaking changes:** All existing types maintained
- **DRAAD-155 compatible:** UPDATE pattern only
- **DRAAD-202 compatible:** Type fixes maintained
- **Backward compatible:** Frontend works with new response
- **Async-first:** No blocking operations
- **Dutch-first:** All user messages in Dutch

---

**Datum:** 2025-12-17 22:20 CET  
**Status:** ‚úÖ TECHNICAL SPEC COMPLETE
