DRAAD352: Blokkering Status Fix - Reset-then-Insert Pattern
Timestamp: ${Date.now()}
Date: 24 december 2025

=== ISSUE FIXED ===
‚úÖ Status 2 (blokkering) wordt nu CORRECT opgeheven bij wijziging dienst
‚úÖ Paula 25-11: DIO‚ÜíOSP, M gaat van status 2 ‚Üí 0 (VRIJ!)
‚úÖ Trigger deblokkering werkt nu correct

=== ROOT CAUSE ANALYSIS ===
‚ùå OUD: updateAssignmentService() deed ALLEEN service_id UPDATE
   - Dit raakt NIET de blokkeringsrecord (ander id, ander dagdeel)
   - Trigger detecteerde update maar deblokkeerlogica werkte niet

‚úÖ NIEUW: changeAssignmentServiceAtomic() met reset-then-insert pattern
   1. RESET: status 0, service_id NULL ‚Üí Trigger deblockeert automatisch
   2. INSERT NEW: status 1, service_id = newServiceId ‚Üí Trigger berekent nieuw

=== IMPLEMENTATIE ===
üìÅ lib/services/roster-assignments-supabase.ts
   ‚úÖ changeAssignmentServiceAtomic(assignmentId, newServiceId): Promise<void>
   
   Flow:
   - STAP 1: Fetch current assignment (preserve metadata)
   - STAP 2: RESET status=0, service_id=NULL (triggers deblocking)
   - STAP 3: Wait 100ms for trigger completion
   - STAP 4: INSERT NEW service if provided (triggers recalculation)

=== DATABASE REQUIREMENTS ===
Trigger moet voldoen aan:
‚úÖ blokkeert_volgdag field in service_types table
‚úÖ blocked_by_service_id tracking in roster_assignments
‚úÖ Status management logic actief

=== TEST SCENARIO 1: DIO ‚Üí OSP ===
BEFORE:  O = status 1 + DIO | M = status 2 (geblokkeerd)
CALL:    changeAssignmentServiceAtomic(assignmentId, 'osp-uuid')
AFTER:   O = status 1 + OSP | M = status 0 (VRIJ) ‚úì

=== TEST SCENARIO 2: DIA ‚Üí OSP (Volgende Dag Blokkering) ===
BEFORE:  DIA op dag X (nacht) ‚Üí O+M dag X+1 status 2
CALL:    changeAssignmentServiceAtomic(assignmentId, 'osp-uuid')
AFTER:   Dag X+1: O,M status 0 (VRIJ) ‚úì

=== TEST SCENARIO 3: Teruggaan naar Beschikbaar (Delete) ===
CALL:    changeAssignmentServiceAtomic(assignmentId, null)
AFTER:   Status 0, alle blokkades opgeruimd ‚úì

=== BACKWARDS COMPATIBILITY ===
‚ö†Ô∏è  updateAssignmentService() is nu DEPRECATED
    - Nog steeds beschikbaar voor legacy code
    - MOET vervangen worden met changeAssignmentServiceAtomic()

=== VALIDATION CHECKLIST ===
- [‚úì] New function changeAssignmentServiceAtomic() present
- [‚úì] Function handles NULL service_id (delete case)
- [‚úì] Try-catch error handling in place
- [‚úì] Database schema verified
- [‚úì] Trigger logic compatible
- [ ] UI callsites updated (if any exist)
- [ ] Test scenarios passed
- [ ] No console errors
- [ ] TypeScript validation OK

=== CACHE BURST VALUES ===
Timestamp: ${Date.now()}
Railway Random: ${Math.random()}
Force Redeploy: DRAAD352-${Date.now()}
