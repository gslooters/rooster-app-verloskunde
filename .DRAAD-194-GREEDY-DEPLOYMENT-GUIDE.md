# üöÄ **GREEDY SERVICE DEPLOYMENT GUIDE**

**DRAAD-194: FASE 3 - NEW RAILWAY SERVICE SETUP**  
Datum: 16 December 2025  
Doel: Stap-voor-stap gids voor GREEDY service deployment op Railway  

---

## üìã **PRE-DEPLOYMENT CHECKLIST**

Voordat je start, zorg dat je het volgende hebt:

```
‚òê GitHub account met push access tot: gslooters/rooster-app-verloskunde
‚òê Railway.com account met owner/admin role
‚òê Access tot Railway project: roostervarw1
‚òê Supabase credentials (URL + Key) van bestaande Solver2 service
‚òê Docker knowledge (basic)
‚òê ~15 minuten tijd
```

---

## üîÑ **STAP 1: RAILWAY CONSOLE OPENEN**

### 1.1 Login op Railway

```
1. Go to: https://railway.app
2. Login with your Railway credentials
3. Navigate to project: roostervarw1
   URL: https://railway.app/project/90165889-1a50-4236-aefe-b1e1ae44dc7f
```

### 1.2 Project Overview

Je ziet nu het project dashboard met:
- ‚úÖ Existing service: `roostervarw1` (Solver2)
- ‚úÖ Environment: `Production`
- ‚úÖ Plugins: PostgreSQL (Supabase)

---

## ‚ûï **STAP 2: CREATE NEW SERVICE**

### 2.1 Add Service

```
1. Click button: "+ Add Service"
2. Choose: "GitHub Repo"
3. Select repository: gslooters/rooster-app-verloskunde
4. Select branch: main
```

### 2.2 Configure Service

```
Service Name:      roostervarw1-greedy
Environment:       Production
Repository:        gslooters/rooster-app-verloskunde
Branch:            main
Root Directory:    (leave empty)
```

### 2.3 Select Build Configuration

```
1. Railway detects: Dockerfile.greedy
2. Confirm: "Use Dockerfile.greedy"
3. Click: "Create"
```

‚è≥ Railway now creates the service (takes ~1 minute)

---

## ‚öôÔ∏è **STAP 3: CONFIGURE ENVIRONMENT**

### 3.1 Service Settings

In Railway console, go to service: `roostervarw1-greedy`

**General Tab:**
```
Service Name: roostervarw1-greedy
Public Domain: (auto-generated, e.g., roostervarw1-greedy-xxxx.railway.app)
```

### 3.2 Set Port

```
1. Go to: Settings tab
2. Find: "PORT"
3. Set value: 8001
4. Save
```

### 3.3 Environment Variables

**Add these variables:**

| Variable | Value | Type |
|----------|-------|------|
| `PORT` | 8001 | Public |
| `ENVIRONMENT` | production | Public |
| `PYTHONUNBUFFERED` | 1 | Public |
| `GREEDY_ENGINE_MODE` | production | Public |

**Add from Solver2 service (copy from existing):**

| Variable | Value | Type |
|----------|-------|------|
| `SUPABASE_URL` | (copy from Solver2) | Secret |
| `SUPABASE_KEY` | (copy from Solver2) | Secret |

**How to copy from Solver2:**

```
1. Switch to service: roostervarw1 (Solver2)
2. Go to: Variables tab
3. Find: SUPABASE_URL and SUPABASE_KEY
4. Note the values (or click the copy icon)
5. Switch back to: roostervarw1-greedy
6. Add these same values
```

### 3.4 Health Checks

**Railway should auto-detect from Dockerfile.greedy:**

```
Liveness Check:
- Enabled: Yes
- Path: /health
- Timeout: 10 seconds
- Initial Delay: 5 seconds
- Interval: 30 seconds

Readiness Check:
- Enabled: Yes
- Path: /health
- Timeout: 5 seconds
- Initial Delay: 5 seconds
- Interval: 10 seconds
```

If not auto-detected, add manually.

---

## üèóÔ∏è **STAP 4: BUILD & DEPLOY**

### 4.1 Trigger Build

```
1. Go to: Deployments tab
2. Click: "Manual Deploy" (or wait for auto-deploy)
3. Watch build progress in logs
```

### 4.2 Build Output (Expected)

```
[1/10] FROM python:3.11-slim
[2/10] WORKDIR /app
[3/10] RUN apt-get update && apt-get install...
[4/10] COPY requirements-greedy.txt .
[5/10] RUN pip install --no-cache-dir -r requirements-greedy.txt
        (should take ~30-45 seconds)
[6/10] COPY src/solver/ .
[7/10] COPY src/services/greedy_api.py .
[8/10] ENV PORT=8001
[9/10] HEALTHCHECK --interval=30s...
[10/10] CMD ["python", "-m", "uvicorn"...]

Build successful! ‚úÖ
```

### 4.3 Deployment Status

Wait for status to change:
```
Building... ‚Üí Building successful ‚úÖ ‚Üí Deploying...
```

‚è≥ Deployment takes ~2-3 minutes

---

## üîç **STAP 5: VERIFY DEPLOYMENT**

### 5.1 Check Status in Railway

```
Status should show: üü¢ ONLINE
Replicas: 1/1
Health: Healthy
```

### 5.2 Get Public URL

```
1. In Railway console
2. Look for: "Public Domain"
3. Copy the URL: https://roostervarw1-greedy-xxxx.railway.app
```

### 5.3 Test Health Endpoint

**Option A: Browser**
```
https://roostervarw1-greedy-xxxx.railway.app/health

Expected response:
{
  "status": "healthy",
  "timestamp": "2025-12-16T13:45:00.123456",
  "service_name": "GREEDY Engine API",
  "version": "1.0.0"
}
```

**Option B: Terminal (curl)**
```bash
curl https://roostervarw1-greedy-xxxx.railway.app/health
```

### 5.4 Check Logs

```
1. Go to: Logs tab
2. Look for:
   ‚úÖ "GREEDY API Service starting..."
   ‚úÖ "GREEDY API Service ready"
   ‚úÖ "Application startup complete"

3. No errors should appear
```

---

## üì° **STAP 6: TEST API ENDPOINT**

### 6.1 Test Solve Endpoint

**Using curl:**

```bash
curl -X POST https://roostervarw1-greedy-xxxx.railway.app/api/greedy/solve \
  -H "Content-Type: application/json" \
  -d '{
    "roster_id": "550e8400-e29b-41d4-a716-446655440000",
    "solve_time_limit": 5,
    "min_coverage_target": 0.95,
    "prefer_balanced_workload": true
  }'
```

**Expected response:**
```json
{
  "success": true,
  "solve_time_seconds": 2.45,
  "total_assignments": 287,
  "coverage_rate": 0.9623,
  "assignments": [...],
  "constraint_violations": null,
  "metadata": {...}
}
```

### 6.2 Check Response

```
‚úÖ "success": true  ‚Üí Solve executed
‚úÖ "solve_time_seconds": 2.45  ‚Üí Very fast!
‚úÖ "coverage_rate": 0.9623  ‚Üí 96%+ coverage
‚úÖ "total_assignments": 287  ‚Üí Results returned
```

---

## üîê **STAP 7: UPDATE FRONTEND**

### 7.1 Add Environment Variable

**File: `.env.production`**

```bash
# GREEDY Service endpoint
REACT_APP_GREEDY_ENDPOINT=https://roostervarw1-greedy-xxxx.railway.app
```

**Or in Railway frontend service:**

```
Variables tab ‚Üí Add:
GREEDY_ENDPOINT = https://roostervarw1-greedy-xxxx.railway.app
```

### 7.2 Update Dashboard

**File: `pages/rooster-editor/RoosterDashboard.tsx`**

```typescript
// Add button for GREEDY
const handleSolveGreedy = async () => {
  const endpoint = process.env.REACT_APP_GREEDY_ENDPOINT;
  const response = await fetch(`${endpoint}/api/greedy/solve`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      roster_id: rosterId,
      solve_time_limit: 5,
      min_coverage_target: 0.95,
      prefer_balanced_workload: true
    })
  });
  // Handle response...
};
```

### 7.3 Add UI Elements

```jsx
<button onClick={handleSolveGreedy} className="btn-primary">
  ‚ö° Solve FAST (GREEDY - 2-5 sec)
</button>

<button onClick={handleSolveSolver2} className="btn-secondary">
  üîç Solve DEEP (Solver2 - 60-120 sec)
</button>
```

---

## üß™ **STAP 8: INTEGRATION TESTING**

### 8.1 Test Both Solvers

```
1. Open Dashboard
2. Load a roster
3. Click: "Solve FAST (GREEDY)"
   - Wait 2-5 seconds
   - Check results
   - Compare coverage

4. Click: "Solve DEEP (Solver2)"
   - Wait 60-120 seconds
   - Check results
   - Compare coverage
```

### 8.2 Compare Results

| Metric | GREEDY | Solver2 | Notes |
|--------|--------|---------|-------|
| Solve time | 2-5 sec | 60-120 sec | GREEDY is 20-40x faster |
| Coverage | 95-98% | 80%+ | GREEDY achieves better coverage |
| Constraints | All hard ‚úÖ | Soft relaxable | GREEDY respects all hard constraints |
| Workload balance | Good | Good | Both balance workload |

### 8.3 Error Testing

```
1. Test with invalid roster_id:
   ‚Üí Should return error with clear message

2. Test with no coverage achievable:
   ‚Üí Should return what it could find

3. Test health endpoint:
   ‚Üí Should return 200 status

4. Simulate GREEDY down:
   ‚Üí Frontend should handle gracefully
   ‚Üí User should see error message
```

---

## üÜò **TROUBLESHOOTING**

### Issue: "Build failed: Module not found"

```
Solution:
1. Check requirements-greedy.txt is in repo root
2. Check Dockerfile.greedy paths are correct
3. Check all Python files in src/solver/ exist
4. Retry build in Railway console
```

### Issue: "Health check failed"

```
Solution:
1. Check service is running (logs should show startup)
2. Try accessing /health endpoint directly
3. Check if SUPABASE credentials are set correctly
4. Look at logs for "GREEDY API Service ready" message
```

### Issue: "Cannot connect to GREEDY endpoint"

```
Solution:
1. Verify public URL is correct in Railway
2. Check GREEDY_ENDPOINT env var in frontend
3. Test endpoint with curl first
4. Check firewall/CORS settings (should be open)
```

### Issue: "500 error on /api/greedy/solve"

```
Solution:
1. Check logs for Python traceback
2. Verify roster_id is valid UUID
3. Verify Supabase connection working
4. Check constraint files exist and load correctly
```

---

## üìä **MONITORING**

### Real-time Monitoring

```
1. Go to Railway service: roostervarw1-greedy
2. Logs tab:
   - Watch for requests
   - Check response times
   - Look for errors

3. Metrics tab:
   - CPU usage (should be low when idle)
   - Memory usage (should be <200MB)
   - Request count
   - Response times
```

### Set Alerts (Optional)

```
1. Railway Alerts:
   - If service is down
   - If CPU > 80%
   - If error rate > 5%

2. Custom monitoring:
   - Use external service like Sentry
   - Log aggregation
   - Performance tracking
```

---

## ‚úÖ **SUCCESSFUL DEPLOYMENT CHECKLIST**

```
‚òë Service created in Railway: roostervarw1-greedy
‚òë Build completed successfully ‚úÖ
‚òë Service status: üü¢ ONLINE
‚òë Health check: passing
‚òë /health endpoint returns 200
‚òë /api/greedy/solve accepts requests
‚òë Solve time: 2-5 seconds
‚òë Coverage rate: > 95%
‚òë Frontend shows both buttons
‚òë Both buttons work and return results
‚òë No error messages in logs
‚òë Solver2 still working (no impact)
```

---

## üéâ **DEPLOYMENT COMPLETE!**

Congratulations! GREEDY service is now live.

**Next steps:**
- Monitor logs for 24 hours
- Get feedback from users
- Consider performance optimizations
- Document any issues found

**Architecture is now:**
```
‚úÖ GREEDY: Fast solver (2-5 sec, 95%+ coverage)
‚úÖ Solver2: Deep solver (60-120 sec, 80%+ coverage)
‚úÖ Both services: Parallel, independent, no conflicts
‚úÖ User choice: Pick the right solver for the job
```

---

**Guide created:** 16 December 2025, 13:40 CET  
**Status:** Ready for production deployment  
**Questions?** Check `.DRAAD-194-FASE3-EXECUTION-COMPLETE.md`
