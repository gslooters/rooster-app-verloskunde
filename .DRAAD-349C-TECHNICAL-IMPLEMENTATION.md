# DRAAD 349 C - Technische Implementatie Details

## Component Architecture

### RoosterLayout.tsx

**Locatie:** `/src/components/RoosterBewerking/RoosterLayout.tsx`
**Type:** React Functional Component (Next.js 'use client')
**Deps:** supabase, React hooks, Tailwind CSS

### Props Interface

```typescript
interface RoosterLayoutProps {
  rosterId: string;                          // UUID van roster_id
  employees: Employee[];                     // Alle medewerkers
  serviceTypes: ServiceType[];               // Alle diensten
  initialData?: Map<...>;                   // Optional pre-loaded data
}
```

**Employee Fields Used:**
- `id` - employee_id (primary key)
- `voornaam`, `achternaam` - naam display
- `team` - team grouping
- `aantalwerkdagen` - Wd kolom waarde

**ServiceType Fields Used:**
- `id` - service_id (primary key)
- `code` - DDO, DDA, etc (badge label)
- `dienstwaarde` - numeric value (Pd berekening)
- `kleur` - hex color (cell background)

**RoosterData Structure:**
```typescript
Map<employee_id: string, Map<service_id: string, aantal: number>>
```

---

## State Management

### Primary State

```typescript
const [roosterData, setRoosterData] = useState<
  Map<string, Map<string, number>>
>(initialData || new Map())
```

**Lifecycle:**
1. Initialize van propsâ€¯`initialData` OR fetch via `useEffect`
2. Update via `updateServiceCount()` callback
3. Persist changes naar Supabase
4. Fallback refetch on error

### Loading State

```typescript
const [isUpdating, setIsUpdating] = useState(false)
```

**Triggers:** Disables buttons during async updates

---

## Key Functions

### 1. fetchRoosterData()

```typescript
const fetchRoosterData = async () => {
  const { data, error } = await supabase
    .from('roster_employee_services')
    .select('employee_id, service_id, aantal, actief')
    .eq('roster_id', rosterId)
    .eq('actief', true);  // Only active records

  // Convert array to Map for O(1) lookup
  const newData = new Map<string, Map<string, number>>();
  // ... populate newData from data array
  setRoosterData(newData);
}
```

**Called:** Component mount (useEffect)

### 2. updateServiceCount() - CRITICAL (No Reload)

```typescript
const updateServiceCount = useCallback(
  async (employeeId: string, serviceId: string, newCount: number) => {
    setIsUpdating(true);

    try {
      // STEP 1: Optimistic UI update (instant feedback)
      const newData = new Map(roosterData);
      newData.get(employeeId)!.set(serviceId, newCount);
      setRoosterData(newData);

      // STEP 2: Database persist (background)
      const { error } = await supabase
        .from('roster_employee_services')
        .update({
          aantal: newCount,
          updated_at: new Date().toISOString()  // Timestamp for audit
        })
        .eq('roster_id', rosterId)
        .eq('employee_id', employeeId)
        .eq('service_id', serviceId);

      if (error) throw error;

      // STEP 3: No reload! Component re-renders from state change
      console.log(`âœ… Updated ${employeeId} ${serviceId} to ${newCount}`);
    } catch (error) {
      // STEP 4: Fallback - refetch all data on error
      console.error('Fout bij update:', error);
      await fetchRoosterData();
    } finally {
      setIsUpdating(false);
    }
  },
  [roosterData, rosterId]
);
```

**Key Pattern:** Optimistic Updates
1. Update UI immediately
2. Sync with database in background
3. Revert on error
4. **Never do window.location.reload()**

### 3. calculatePd(employeeId: string)

```typescript
const calculatePd = (employeeId: string): number => {
  const employeeServices = roosterData.get(employeeId);
  if (!employeeServices) return 0;

  let total = 0;
  employeeServices.forEach((aantal, serviceId) => {
    const service = serviceTypes.find(s => s.id === serviceId);
    if (service) {
      total += aantal * service.dienstwaarde;
    }
  });
  return total;
};
```

**Formula:** Pd = Î£(aantal_i Ã— dienstwaarde_i)

### 4. getPdColor(employeeId: string)

```typescript
const getPdColor = (employeeId: string): string => {
  const employee = employees.find(e => e.id === employeeId);
  if (!employee) return 'text-gray-600';

  const pd = calculatePd(employeeId);
  const wd = employee.aantalwerkdagen;

  if (pd === wd) return 'text-green-600 font-bold';
  if (pd < wd) return 'text-red-600 font-bold';
  return 'text-gray-600';
};
```

**Color Logic:**
- ðŸŸ¢ **Green** (pd === wd): Perfect balance
- ðŸ”´ **Red** (pd < wd): Shortage/under-staffed
- âšª **Gray** (pd > wd): Over-staffed

### 5. getTeamTotals(serviceId: string)

```typescript
const getTeamTotals = (serviceId: string) => {
  const totals = new Map<string, number>();
  let grandTotal = 0;

  employees.forEach(emp => {
    const services = roosterData.get(emp.id);
    const count = services?.get(serviceId) || 0;
    
    // Accumulate by team
    if (!totals.has(emp.team)) {
      totals.set(emp.team, 0);
    }
    totals.set(emp.team, totals.get(emp.team)! + count);
    grandTotal += count;
  });

  return { totals, grandTotal };
};
```

**Returns:** 
- `totals`: Map<team, sum_of_counts>
- `grandTotal`: Total across all teams

---

## Layout Structure

### 1. Sticky Header Row

```tsx
<thead className="sticky top-0 bg-gray-100 z-10 border-b-2 border-gray-300 shadow-md">
  <tr>
    {/* Medewerker */}
    <th className="px-3 py-2 text-left font-bold text-sm min-w-[150px]">
      Medewerker
    </th>

    {/* Wd (Werkdagen) */}
    <th className="px-3 py-2 text-center font-bold text-sm min-w-[50px] bg-blue-50">
      Wd
    </th>

    {/* Pd (Personeelslasten) */}
    <th className="px-3 py-2 text-center font-bold text-sm min-w-[50px] bg-blue-50">
      Pd
    </th>

    {/* Services */}
    {serviceTypes.map(service => (
      <th
        key={service.id}
        style={{ backgroundColor: service.kleur || '#f0f0f0' }}
        className="px-2 py-2 text-center font-bold text-xs min-w-[100px]"
      >
        <div className="flex flex-col items-center gap-0.5">
          <span className="font-bold text-sm">{service.code}</span>
          <span className="text-xs font-normal text-gray-600">
            waarde: {service.dienstwaarde}
          </span>
        </div>
      </th>
    ))}
  </tr>
</thead>
```

**CSS Key:**
- `sticky top-0` - Stays at viewport top
- `z-10` - Above body content
- `shadow-md` - Visual separation
- `bg-blue-50` - Wd/Pd background
- `service.kleur` - Dynamic service colors

### 2. Employee Data Rows

```tsx
<tbody>
  {employees.map(employee => (
    <tr key={employee.id} className="border-b border-gray-200 hover:bg-gray-50">
      {/* Name & Team */}
      <td className="px-3 py-2 font-medium text-sm">
        <div>
          <div className="font-semibold text-gray-800">
            {employee.voornaam} {employee.achternaam}
          </div>
          <div className="text-xs text-gray-500">{employee.team}</div>
        </div>
      </td>

      {/* Wd Value */}
      <td className="px-3 py-2 text-center font-bold text-sm bg-blue-50">
        {employee.aantalwerkdagen}
      </td>

      {/* Pd Value with Color */}
      <td className={`px-3 py-2 text-center font-bold text-sm bg-blue-50 ${getPdColor(employee.id)}`}>
        {calculatePd(employee.id).toFixed(1)}
      </td>

      {/* Service Counts */}
      {serviceTypes.map(service => {
        const count = roosterData.get(employee.id)?.get(service.id) || 0;
        return (
          <td key={`${employee.id}-${service.id}`} className="px-2 py-2">
            <div className="flex items-center justify-center gap-2">
              {/* [-] Button */}
              <button
                onClick={() => updateServiceCount(employee.id, service.id, Math.max(0, count - 1))}
                disabled={isUpdating}
                className="px-2 py-1 text-xs bg-white border border-gray-300 rounded hover:bg-gray-100"
              >
                âˆ’
              </button>

              {/* Count Display */}
              <span className="min-w-[24px] text-center font-bold text-sm">
                {count}
              </span>

              {/* [+] Button */}
              <button
                onClick={() => updateServiceCount(employee.id, service.id, count + 1)}
                disabled={isUpdating}
                className="px-2 py-1 text-xs bg-white border border-gray-300 rounded hover:bg-gray-100"
              >
                +
              </button>
            </div>
          </td>
        );
      })}
    </tr>
  ))}
</tbody>
```

**Button Layout:** `[-] [count] [+]` (Image2 Style)
- Minimal width
- Disabled when `isUpdating`
- Click triggers `updateServiceCount()`

### 3. Team Totals Footer

```tsx
{/* Praktijk Total Row */}
<tr className="font-bold bg-gray-100 border-b-2 border-gray-400">
  <td className="px-3 py-2 font-bold">Praktijk Totaal</td>
  <td className="px-3 py-2 text-center bg-blue-100">
    {employees.reduce((sum, e) => sum + e.aantalwerkdagen, 0)}
  </td>
  <td className="px-3 py-2 text-center bg-blue-100">
    {employees.reduce((sum, e) => sum + calculatePd(e.id), 0).toFixed(1)}
  </td>
  {serviceTypes.map(service => {
    const { grandTotal } = getTeamTotals(service.id);
    return (
      <td key={`total-${service.id}`} className="px-2 py-2 text-center font-bold bg-blue-50">
        {grandTotal}
      </td>
    );
  })}
</tr>

{/* Team Subtotal Rows */}
{Array.from(new Set(employees.map(e => e.team))).map(team => {
  const teamEmployees = employees.filter(e => e.team === team);
  return (
    <tr key={`team-total-${team}`} className="text-sm bg-gray-50">
      <td className="px-3 py-2 font-semibold">Team: {team}</td>
      {/* Wd, Pd, Services totals for this team */}
    </tr>
  );
})}
```

**Color Scheme:**
- ðŸŸ¦ **Blue (bg-blue-100)** - Praktijk Totaal
- ðŸŸ§ **Orange (bg-orange-50)** - Team Subtotals
- Service-specific colors for service columns

---

## Database Query Patterns

### Initial Load

```sql
SELECT employee_id, service_id, aantal, actief
FROM roster_employee_services
WHERE roster_id = $1 AND actief = true
ORDER BY employee_id, service_id
```

### Update Single Entry

```sql
UPDATE roster_employee_services
SET aantal = $1, updated_at = $2
WHERE roster_id = $3
  AND employee_id = $4
  AND service_id = $5
```

**Note:** No DELETE/INSERT, just UPDATE aantal field

---

## Performance Optimizations

1. **Map-based Data Structure**
   - O(1) lookup: `roosterData.get(empId).get(serviceId)`
   - Better than array iteration

2. **useCallback Hook**
   - Memoizes `updateServiceCount` with `[roosterData, rosterId]` deps
   - Prevents unnecessary function recreations

3. **Optimistic Updates**
   - UI updates before DB confirms
   - User gets instant feedback
   - Fallback refetch on error

4. **Sticky Header with Z-index**
   - `sticky top-0` CSS
   - `z-10` keeps it above scrolling content
   - No JavaScript scroll listeners needed

---

## Integration Points

### Parent Component Usage

```typescript
import RoosterLayout from '@/components/RoosterBewerking/RoosterLayout';

// In parent component:
<RoosterLayout
  rosterId={currentRoster.id}
  employees={employeeList}
  serviceTypes={serviceTypeList}
  initialData={preloadedData}  // Optional
/>
```

### Data Flow

```
[Parent]
   |
   +---> [RoosterLayout]
            |
            +---> fetch roster_employee_services
            |
            +---> render sticky header
            |
            +---> render employee rows with counts
            |
            +---> on click: updateServiceCount
            |
            +---> supabase.update() [no reload!]
            |
            +---> state change triggers re-render
            |
            +---> new Pd color/totals computed
```

---

## Error Handling

### Network Errors
```typescript
try {
  await supabase.from(...).update(...);
} catch (error) {
  console.error('Fout bij update:', error);
  // Fallback: refetch all data
  await fetchRoosterData();
}
```

### Invalid Data
- `Math.max(0, count - 1)` - Prevent negative counts
- `.toFixed(1)` - Consistent decimal display
- `|| 0` - Fallback for missing entries

---

## Testing Checklist

- [ ] Header stays sticky when scrolling horizontally
- [ ] Click +/- buttons: count updates instantly
- [ ] Pd color changes when pd === wd
- [ ] Team totals match sum of individual rows
- [ ] Hard refresh: cache bust works
- [ ] Network offline: error handling works
- [ ] Back to online: data refetches correctly
- [ ] Tab to buttons: keyboard accessibility
- [ ] Mobile: horizontal scroll works smoothly

---

## Deployment Notes

1. **GitHub Push:** âœ… Complete
2. **Cache Bust:** `/public/cache-bust-draad349c.json`
3. **Railway Pull:** Required (git pull origin main)
4. **Build:** Should auto-trigger
5. **Verification:** Test in browser

**No breaking changes - backward compatible with existing code!**
