# üöÄ DRAAD 162B+ IMPLEMENTATION CHECKLIST

**Status:** Ready for Component Integration  
**Deploy Date:** 2025-12-12 12:42 UTC  
**Target:** All screens showing dagdeel data  

---

## üìã CORE HOOKS IMPLEMENTED

‚úÖ `src/lib/hooks/useRealtimeDagdeelSync.ts`
- Real-time listener for dagdeel table changes
- Supports INSERT, UPDATE, DELETE events
- Provides subscribe/unsubscribe control
- Debug logging included

‚úÖ `src/lib/hooks/useDagdeelStateSync.ts`
- State sync helper
- Auto-merges DB updates into React state
- One-liner integration
- Automatic subscription/cleanup

---

## üéØ INTEGRATION POINTS (Priority Order)

### 1Ô∏è‚É£ CRITICAL: Planinformatie Modal
**File:** (Find where PlaninformatieModal component lives)

**Current Code:**
```typescript
const [dagdelen, setDagdelen] = useState<Dagdeel[]>([]);

useEffect(() => {
  loadDagdeelen(rosterId).then(setDagdelen);
}, [rosterId]);
```

**ADD THIS LINE (after useEffect):**
```typescript
import { useDagdeelStateSync } from '@/lib/hooks/useDagdeelStateSync';

// Add this one-liner:
useDagdeelStateSync(dagdelen, setDagdelen, { rosterId, debug: true });
```

**Impact:** Modal will auto-update when dagdeel changes in DB

---

### 2Ô∏è‚É£ HIGH: Diensten per Dagdeel Aanpassen
**File:** (Find the dagdeel adjustment screen)

**Current Code:**
```typescript
const [dagdelen, setDagdelen] = useState<Dagdeel[]>([]);
```

**ADD THIS:**
```typescript
useDagdeelStateSync(dagdelen, setDagdelen, { rosterId });
```

**Note:** No need for manual refresh after PUT - real-time will handle it!

---

### 3Ô∏è‚É£ HIGH: Diensten Toewijzing AANPASSEN
**File:** (Find the assignment screen)

**Current Code:**
```typescript
const [dagdelen, setDagdelen] = useState<Dagdeel[]>([]);
```

**ADD THIS:**
```typescript
useDagdeelStateSync(dagdelen, setDagdelen, { rosterId });
```

**Impact:** Vernieuwen button will work correctly + auto-sync

---

### 4Ô∏è‚É£ MEDIUM: Any other component showing dagdelen
Repeat pattern above for all components displaying dagdeel data

---

## ‚úÖ VERIFICATION STEPS

### Step 1: Deploy Code
```bash
# All changes already committed to main
# Railway will auto-deploy on push
```

### Step 2: Test Planinformatie Modal
1. Open Diensten per Dagdeel Aanpassen
2. Change SWZ from 2 ‚Üí 1
3. Open Planinformatie modal
4. **Expected:** Value immediately shows 1 (not 2)
5. **Time:** < 1 second

### Step 3: Test Vernieuwen Button
1. In Diensten Toewijzing, add SWZ +1
2. Click Vernieuwen
3. **Expected:** +1 persists (not reverted)
4. Check Planinformatie
5. **Expected:** Shows correct updated value

### Step 4: Test Cross-Screen Sync
1. Open two screens showing dagdelen
2. Modify dagdeel in one screen
3. **Expected:** Both screens update simultaneously
4. **Time:** < 1 second

### Step 5: Console Verification
Open Browser DevTools Console
```
‚úÖ Look for: "Real-time dagdeel listener ACTIVE"
‚úÖ Look for: "[DRAAD162B-SYNC] Updating state"
‚úÖ Look for: "Dagdeel UPDATE received:"
‚ùå Should NOT see: "Supabase client not available"
```

---

## üîß TROUBLESHOOTING

### Problem: "Supabase client not available"
**Solution:**
```typescript
// In your main app initialization file:
import { supabase } from '@/lib/supabase';

// Make client available globally:
if (typeof window !== 'undefined') {
  (window as any).__SUPABASE_CLIENT__ = supabase;
}
```

### Problem: Real-time events not triggering
**Solution:**
1. Check Supabase project settings ‚Üí Realtime
2. Verify `postgres_changes` is enabled
3. Check network tab ‚Üí WebSocket connection should be open

### Problem: State not updating after integration
**Solution:**
1. Make sure `useDagdeelStateSync` is called AFTER `useState`
2. Check rosterId is passed correctly
3. Enable debug mode: `{ debug: true }`
4. Check console logs

---

## üìä EXPECTED BEHAVIOR AFTER INTEGRATION

| Scenario | Before | After Integration |
|----------|--------|-------------------|
| Change dagdeel, open Planinformatie | Old value (delay) | Fresh value (instant) |
| Click Vernieuwen | Change reverts | Change persists |
| Switch screens | Values out of sync | All screens synchronized |
| Browser console | No real-time logs | Shows real-time events |
| User clicks Refresh (F5) | Required | Not needed anymore |

---

## üéØ INTEGRATION FLOW

```
1. User makes change
   ‚Üì
2. PUT /api/dagdeel (database updates)
   ‚Üì
3. Supabase sends real-time event
   ‚Üì
4. useRealtimeDagdeelSync receives event
   ‚Üì
5. useDagdeelStateSync callback triggered
   ‚Üì
6. React state updated via setDagdelen
   ‚Üì
7. Component re-renders with new data
   ‚Üì
8. User sees update immediately ‚úÖ
```

---

## üìù CODE TEMPLATE

**Copy-paste this into your components:**

```typescript
import { useState, useEffect } from 'react';
import { useDagdeelStateSync } from '@/lib/hooks/useDagdeelStateSync';

interface Dagdeel {
  id: string;
  [key: string]: any;
}

export function MyComponent({ rosterId }: { rosterId: string }) {
  const [dagdelen, setDagdelen] = useState<Dagdeel[]>([]);
  const [loading, setLoading] = useState(true);

  // Load initial data
  useEffect(() => {
    async function loadData() {
      try {
        const data = await fetchDagdeelen(rosterId);
        setDagdelen(data);
      } finally {
        setLoading(false);
      }
    }
    loadData();
  }, [rosterId]);

  // üü¢ ADD THIS - Auto-sync with real-time updates!
  useDagdeelStateSync(dagdelen, setDagdelen, {
    rosterId,
    debug: process.env.NODE_ENV === 'development',
  });

  if (loading) return <Loading />;

  return (
    <div>
      {dagdelen.map((d) => (
        <DagdeelRow key={d.id} dagdeel={d} />
      ))}
    </div>
  );
}
```

---

## üöÄ DEPLOYMENT STEPS

‚úÖ **Step 1: Code Complete**
- useRealtimeDagdeelSync.ts ‚úÖ
- useDagdeelStateSync.ts ‚úÖ
- Documentation ‚úÖ
- Cache buster ‚úÖ

‚è≥ **Step 2: Component Integration** (Next)
- Add hooks to Planinformatie Modal
- Add hooks to Diensten per Dagdeel
- Add hooks to Diensten Toewijzing
- Test verification

üöÄ **Step 3: Deployment** (After verification)
- Commit changes
- Railway auto-deploys
- Monitor logs
- Verify real-time working

---

## üìû SUPPORT

**Real-time not working?**
Check:
1. Supabase client available globally
2. WebSocket connection open (DevTools ‚Üí Network)
3. Realtime enabled in Supabase dashboard
4. Debug logs in console

**State not updating?**
Check:
1. rosterId passed correctly
2. Hook called after useState
3. Table name correct (should be 'dagdeel')
4. Enable debug mode

---

**Generated:** 2025-12-12 12:42 UTC  
**Version:** DRAAD162B-CHECKLIST-v1  
**Status:** Ready for Component Integration  
