# ğŸ”´ DRAAD176-AAA - ECHTE ROOT CAUSE: RAILWAY STALE SNAPSHOT

**Status**: ğŸ”´ **DEPLOYMENT FAILURE #5 - STALE SNAPSHOT IDENTIFIED**  
**Date**: 2025-12-14T16:03:00Z  
**Issue**: Railway Railpack using STALE snapshot from BEFORE fixes  
**Root Cause**: NOT the railway.toml or package.json - Railway is using OLD SOURCE

---

## ğŸ” CRITICAL DISCOVERY

### The Mystery

```
Mijn fix: Removed 'nixpacks = "node-20"' from railway.toml âœ… DONE
Railway toml check: File is CORRECT (no nixpacks line) âœ… VERIFIED
BUT: Railway STILL fails with SAME ERROR âŒ STILL BROKEN

Error: âœ– Failed to resolve version 20 of node
```

### The Investigation

Vergelijken van **commit SHA** vs **snapshot SHA**:

```
My Latest Commit SHA:
287885df67f5547cd2a0cf2e5665b6ebbbee7452

Railway Snapshot SHA (from failed log):
39ad8b0ae3342c33a5ea4274bdefa25a90303d40

âŒ NIET HETZELFDE!
Dit betekent: Railway is een OUDE SNAPSHOT aan het gebruiken!
```

### The Smoking Gun

From failed Railway log:
```
2025-12-14T14:59:57.601010646Z [inf]  [snapshot] received sha256:39ad8b0ae3...
2025-12-14T14:59:57.641015309Z [dbg]  found 'railway.toml' at 'railway.toml'
```

**Het probleem:**
- Snapshot SHA `39ad8b0ae3...` is van VOOR mijn fixes
- Railway trekt deze stale snapshot
- Stale snapshot bevat OUDE railway.toml (met `nixpacks = "node-20"`)
- Mijn nieuwe fixes worden GENEGEERD
- Railpack probeert `nixpacks = "node-20"` 
- Build faalt op Node resolution

---

## ğŸ¯ WHY THIS HAPPENS

### Railway Build Process

1. **Snapshot Creation**: Railway snapshots repo at certain point
2. **Caching**: Snapshots worden gecached voor performance
3. **Build Trigger**: Wanneer je push, Railway hoeft NIET altijd frisse snapshot
4. **Stale Snapshot Issue**: Soms gebruikt Railway oude snapshot van `git history`

### The Problem Flow

```
Time 14:51 â†’ Ik fix railway.toml, push commits
         â†’ My commits: 38b1001, 360d276, 287885df
         â†’ Railway SEES new HEAD: 287885df

Time 14:59 â†’ Railway auto-triggers build
         â†’ But uses OLD snapshot SHA: 39ad8b0
         â†’ This snapshot is from BEFORE my fixes
         â†’ Railway Railpack reads STALE railway.toml
         â†’ Still has 'nixpacks = "node-20"'
         â†’ Build fails!
```

---

## âœ… THE REAL FIX

### What I Did (Incomplete)

âŒ Fixed railway.toml (correct, but not sufficient)  
âŒ Added cache-buster files (helpful, but Railway ignored them)  
âŒ Thought the problem was solved (it wasn't)

### What Railway Needs (Complete)

âœ… **Force Fresh Snapshot**: Railway must discard cached snapshot and fetch FRESH source
âœ… **Clear Railpack Cache**: Railway build system must not use old cached artifacts
âœ… **Rebuild from HEAD**: Must build from latest commit, not cached snapshot

### How to Force Fresh Snapshot

**Option 1: Create New Commit (DONE)**
- File: `.rebuild-trigger-draad176-force-fresh-snapshot`
- Effect: New commit SHA
- Result: Railway sees new HEAD, must fetch fresh snapshot

**Option 2: Manual Railway Intervention**
- Clear build cache in Railway dashboard
- Trigger manual rebuild
- Set `FORCE_CLEAN_BUILD=true` env var

**Option 3: Force Railpack Version Update**
- Create `.railwayrc` with specific settings
- Force Railpack to use newer version
- Enables fresh build

---

## ğŸ“Š TIMELINE - WHAT WENT WRONG

| Time | Event | Status |
|------|-------|--------|
| 14:51 | Initial deployment failure #4 | âŒ FAILED |
| 14:52-14:59 | My analysis and fixes (railway.toml) | âœ… DONE |
| 14:59:57 | Railway auto-triggers build WITH STALE SNAPSHOT | âŒ FAILED |
| 15:00 | I thought fix worked (it didn't) | ğŸ˜… WRONG |
| 15:00-16:00 | I only NOW realize snapshot issue | ğŸ” DISCOVERED |
| 16:03 | Create fresh snapshot trigger commit | â³ TESTING |

---

## ğŸ§ª VERIFICATION

### Current State

```
railway.toml:  âœ… CORRECT (no nixpacks line)
package.json:  âœ… CORRECT (node >=20.0.0)
Code Quality:  âœ… GOOD (no TypeScript errors)
Dependencies:  âœ… VALID (no conflicts)
Snapshot:      âŒ STALE (using old source)
```

### What We're Waiting For

Railway SHOULD:
1. See new commit `5c5b3a80...` (fresh snapshot trigger)
2. Discard stale snapshot `39ad8b0...`
3. Fetch FRESH source from HEAD
4. Read CORRECT railway.toml (without nixpacks line)
5. Execute build: `npm ci && npm run build`
6. Auto-detect Node from package.json: `>=20.0.0`
7. Select Node 20.x version
8. **BUILD SUCCEEDS** âœ…

---

## ğŸ“ LESSONS LEARNED

### Why Initial Fix Failed

1. **I fixed the config file** (railway.toml) âœ…
2. **But Railway was building from old source** âŒ
3. **My fixes weren't in the snapshot Railway used**
4. **Result: Same error, even though I had fixed it** ğŸ˜¤

### Railway Snapshot Caching

- Railway doesn't always fetch fresh source
- It uses cached "snapshots" of your repo
- These snapshots can be STALE
- A new commit forces snapshot refresh
- Files alone don't force refresh - commits do

### Correct Approach

âœ… **Always create a NEW COMMIT** after critical fixes  
âœ… **Don't rely on file changes alone**  
âœ… **New commits trigger fresh snapshots**  
âœ… **Make sure latest source is used**

---

## ğŸš€ NEXT STEPS

### Immediate (Now)

1. **Wait for Railway to build with fresh snapshot**
   - Expected: Next 2-5 minutes
   - Watch: Build logs for new snapshot SHA
   - Success: No `Failed to resolve version` error

2. **Monitor the build**
   - Check Railpack output
   - Verify Node detection: `Detected Node`
   - Verify resolution: `Using npm package manager` âœ…
   - **NOT**: `Failed to resolve version 20 of node`

3. **If Still Fails**
   - Check snapshot SHA in log
   - If still `39ad8b0`: Railway cache not cleared
   - Action: Clear Railway cache manually
   - Action: Redeploy with force option

### Root Cause Analysis

**Why 5 consecutive failures?**

```
Failure #1-4: railway.toml had 'nixpacks = "node-20"' âŒ
Then I fixed it âœ…
Failure #5: Railway used STALE SNAPSHOT from before fix âŒ
```

So actually:
- **4 failures**: Bad config (nixpacks line)
- **1 failure**: Stale snapshot despite fix

**The Fix:**
- Removed bad config âœ…
- Forced fresh snapshot âœ…
- Should work NOW â³

---

## ğŸ“Œ CRITICAL UNDERSTANDING

**The Mistake I Made:**

I thought fixing `railway.toml` would immediately work. But Railway doesn't instantly use your latest files - it uses cached snapshots.

**The Correct Understanding:**

1. Fix the FILE (railway.toml) âœ… Already done
2. Create NEW COMMIT to force fresh snapshot âœ… Just done
3. Railway must discard old snapshot and pull fresh â³ Testing
4. Build from latest source with correct config â³ Testing

**The Lesson:**

> Infrastructure caching can silently break deployments. Always verify that your changes are actually being used, not cached from older versions.

---

## ğŸ¯ SUCCESS CRITERIA

Build is **SUCCESSFUL** when:

```
âœ… Railpack starts
âœ… Detects Node language
âœ… Uses npm package manager
âœ… NO "Failed to resolve version" error
âœ… npm ci completes
âœ… npm run build completes
âœ… Docker image builds
âœ… Health check passes
âœ… Service running
```

**Not successful if:**

```
âŒ Same snapshot SHA (39ad8b0...) used
âŒ Same error message appears
âŒ Railpack can't resolve Node version
```

---

**Document Status**: ANALYSIS COMPLETE  
**Fix Status**: IN PROGRESS  
**Expected Outcome**: â³ AWAITING FRESH SNAPSHOT BUILD  

ğŸ” **The root cause was infrastructure caching, not configuration.**

