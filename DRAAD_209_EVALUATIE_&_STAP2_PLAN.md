# üìã DRAAD 209: EVALUATIE & STAP 2 PLAN\n\n**Datum:** 18 December 2025, 19:00 CET  \n**Status:** STAP 1 ‚úÖ VOLTOOID | STAP 2 ‚è≥ GEREED | STAP 3 ‚è∏Ô∏è WACHT  \n**Eigenaar:** Govard Slooters  \n\n---\n\n## üîç CONTEXT ANALYSE\n\n### STAP 1: Environment Variables (‚úÖ VOLTOOID)\n\n**Screenshot Bevindingen:**\n- ‚úÖ 19 Service Variables in Railway\n- ‚úÖ Alle 9 GREEDY variables aanwezig:\n  - `GREEDY_ENDPOINT`\n  - `GREEDY_TIMEOUT`\n  - `REACT_APP_GREEDY_*` (5 variabelen)\n  - `REACT_APP_GREEDY_HEALTH_CHECK`\n- ‚úÖ \"Apply 9 changes\" ‚Üí Deploy gereed\n- ‚úÖ Auto-redeploy ingesteld\n\n**Status:** ‚úÖ STAP 1 KLAAR\n\n---\n\n## üö® KRITIEKE BEVINDING\n\n### Huidige Probleem: DATABASE WRITES FALEN\n\nVolgens diagnostisch rapport (`OnderzoekGREEDYv2.md`):\n\n```\nV√ì√ìR solve():     1470 records in roster_assignments\nNA solve():       1470 records (EXACT HETZELFDE!)\nRESULT:           ‚ùå GEEN NIEUWE ASSIGNMENTS TOEGEVOEGD\n```\n\n**Symptomen:**\n1. API zegt \"Success: true\" ‚úÖ\n2. Database is onveranderd ‚ùå\n3. Railway logs bevatten geen error ‚ùå\n4. Frontend kan niet zien wat faalt ‚ùå\n\n**Root Cause (70% waarschijnlijkheid):**\n```\nSupabase credentials ontbreken in Railway\n  ‚Üì\ngreedy_engine.py line 83-84: create_client(None, None)\n  ‚Üì\nDatabase write faalt\n  ‚Üì\nException wordt caught\n  ‚Üì\nAPI stuurt HTTP 200 toch\n  ‚Üì\nFrontend ziet false success\n```\n\n---\n\n## ‚ö†Ô∏è WAAROM STAP 3 (DATABASE WRITES TEST) MOET WACHTEN\n\n**We mogen NIET naar STAP 3 gaan zonder STAP 2 code fixes!**\n\n**Waarom:**\n1. ‚ùå Current code stuurt false HTTP 200\n2. ‚ùå Database write failures detecteren is onmogelijk\n3. ‚ùå Logging is onvoldoende voor debugging\n4. ‚ùå Frontend kan falen niet onderscheiden van succes\n5. ‚ùå STAP 3 testing zou geen nuttig resultaat geven\n\n**Actie:** STAP 2 EERST, dan STAP 3\n\n---\n\n## üìù STAP 2: CODE FIXES (3 PRIORITY LEVELS)\n\n### Priority 1 - CRITICAL: Error Handling Fix\n\n**File:** `src/solver/greedy_api.py` line ~50\n\n**Problem:**\n```python\n# CURRENT - WRONG\nresponse = solver_instance.solve(input_data)\nreturn jsonify({\"status\": \"ok\", \"result\": response}), 200  # Always 200!\n```\n\n**Fix:**\n```python\n# CORRECT\ntry:\n    response = solver_instance.solve(input_data)\n    if response.get('status') == 'failed':\n        logger.error(f\"Solve failed: {response.get('message')}\")\n        return jsonify({\n            \"status\": \"error\",\n            \"message\": response.get('message', 'Unknown error'),\n            \"phase\": response.get('phase')\n        }), 500  # Correct HTTP status\n    return jsonify({\"status\": \"success\", \"result\": response}), 200\nexcept Exception as e:\n    logger.error(f\"API error: {str(e)}\", exc_info=True)\n    return jsonify({\n        \"status\": \"error\",\n        \"message\": f\"Solver error: {str(e)}\"\n    }), 500  # HTTP 500 on error\n```\n\n**Impact:** üü¢ Frontend kan nu errors detecteren\n\n**Time:** ~30 min\n\n---\n\n### Priority 2 - HIGH: Enhanced Logging\n\n**File:** `src/solver/greedy_engine.py` line ~480 (Phase 4)\n\n**Problem:**\n```python\n# CURRENT - MINIMAL\ntry:\n    response = self.supabase.table('roster_assignments').insert(data).execute()\n    logger.info(f\"‚úÖ Bulk inserted {len(data)} assignments\")\nexcept Exception as e:\n    logger.error(f\"‚ùå Error: {e}\")\n```\n\n**Fix:**\n```python\n# ENHANCED\nlogger.info(f\"\\nüìù PHASE 4: Saving {len(data)} assignments\")\nlogger.info(f\"   - Supabase URL: {self.supabase.url}\")\nlogger.info(f\"   - Table: roster_assignments\")\nlogger.info(f\"   - Records: {len(data)}\")\n\ntry:\n    response = self.supabase.table('roster_assignments').insert(data).execute()\n    saved_count = len(response.data) if hasattr(response, 'data') else len(data)\n    logger.info(f\"‚úÖ PHASE 4 SUCCESS: Saved {saved_count}\")\n    return {\n        \"status\": \"success\",\n        \"assignments_saved\": saved_count,\n        \"phase\": 4\n    }\nexcept Exception as e:\n    logger.error(f\"‚ùå PHASE 4 FAILED\")\n    logger.error(f\"   - Error: {type(e).__name__}: {str(e)}\")\n    logger.error(f\"   - Attempted: {len(data)} records\")\n    return {\n        \"status\": \"failed\",\n        \"message\": f\"Database write failed: {str(e)}\",\n        \"phase\": 4,\n        \"records_attempted\": len(data)\n    }\n```\n\n**Impact:** üü¢ Logs bevatten volledige context\n\n**Time:** ~20 min\n\n---\n\n### Priority 3 - MEDIUM: Credentials Verification\n\n**File:** `src/solver/greedy_engine.py` line ~83\n\n**Problem:**\n```python\n# CURRENT - NO VALIDATION\nsupabase_url = config.get('supabase_url') or os.getenv('SUPABASE_URL')\nsupabase_key = config.get('supabase_key') or os.getenv('SUPABASE_KEY')\nself.supabase: Client = create_client(supabase_url, supabase_key)  # Fails later!\n```\n\n**Fix:**\n```python\n# VALIDATED\nsupabase_url = config.get('supabase_url') or os.getenv('SUPABASE_URL')\nsupabase_key = config.get('supabase_key') or os.getenv('SUPABASE_KEY')\n\nif not supabase_url or not supabase_key:\n    logger.error(\"‚ùå CRITICAL: Missing Supabase credentials\")\n    logger.error(f\"   - SUPABASE_URL: {'MISSING' if not supabase_url else 'OK'}\")\n    logger.error(f\"   - SUPABASE_KEY: {'MISSING' if not supabase_key else 'OK'}\")\n    raise ValueError(\"Cannot initialize: missing Supabase credentials\")\n\nlogger.info(\"‚úÖ Supabase credentials loaded\")\n\ntry:\n    self.supabase: Client = create_client(supabase_url, supabase_key)\n    logger.info(\"‚úÖ Supabase client initialized\")\nexcept Exception as e:\n    logger.error(f\"‚ùå Supabase init failed: {e}\")\n    raise\n```\n\n**Impact:** üü¢ Fouten gedetecteerd bij startup\n\n**Time:** ~15 min\n\n---\n\n## üìã GREEDY WERKINGSLOGICA (Context)\n\n### Wat GREEDY MOET DOEN\n\n```\n1. Pre-planned services inlezen\n2. Beschikbare medewerkers bepalen (roster_employee_services)\n3. Greedy toewijzing per datum/dagdeel\n4. DIRECT updaten in roster_assignments ‚Üê FASE 4 (FAALT MOMENTEEL!)\n5. Volgende dienst tot alles gepland\n6. Rooster status ‚Üí \"in_progress\"\n7. Rapport aan planner\n```\n\n### Kritieke Planregels\n\n- **Regel 3.1:** Respect status > 0 (geblokkeerde slots)\n- **Regel 3.2:** Alleen bevoegde medewerkers\n- **Regel 3.5:** Medewerker met meeste nog te doen\n- **Regel 3.7:** DIO‚ÜíDIA & DDO‚ÜíDDA koppeling\n\n### Kritieke Tabellen\n\n| Tabel | Records | Purpose |\n|-------|---------|----------|\n| `roster_assignments` | 1470 | ‚Üê MOET WORDEN GEUPDATE |\n| `roster_employee_services` | 106 | RAADPLEGEN (bevoegdheden) |\n| `roster_period_staffing_dagdelen` | 2835 | RAADPLEGEN (vereisten) |\n| `employees` | 14 | RAADPLEGEN |\n| `roosters` | 1 | STATUS UPDATE |\n\n---\n\n## ‚úÖ VERIFICATIE CRITERIA NA FIXES\n\n### Test 1: Error Handling\n```\n- POST /api/greedy/solve met invalid data\n- Expected: HTTP 500 (niet 200)\n- Check: Foutbericht in response\n```\n\n### Test 2: Credentials Check\n```\n- Remove SUPABASE_KEY from Railway\n- Expected: Startup error in logs\n- Check: \"Missing Supabase credentials\" message\n```\n\n### Test 3: Logging Detail\n```\n- POST /api/greedy/solve met valid data\n- Check Railway logs\n- Expected: Phase 4 shows connection info + result\n```\n\n### Test 4: Database Write\n```\n- POST /api/greedy/solve met echte roster data\n- Check: roster_assignments record count verandert\n- Expected: New assignments appear in Supabase\n```\n\n---\n\n## üéØ VOLGENDE DRAAD OPDRACHT\n\n### STAP 2: CODE FIXES IMPLEMENTATIE\n\n**Wat te doen:**\n1. ‚úÖ Implement Priority 1: Error Handling (30 min)\n2. ‚úÖ Implement Priority 2: Enhanced Logging (20 min)\n3. ‚úÖ Implement Priority 3: Credentials Check (15 min)\n4. ‚úÖ Test each fix in Railway (15 min)\n5. ‚úÖ Redeploy to Railway (auto)\n6. ‚úÖ Verify all working (15 min)\n\n**Total Time:** ~95 minutes\n\n**Expected Outcome:**\n- ‚úÖ Database write failures gedetecteerd\n- ‚úÖ Detailed logging beschikbaar\n- ‚úÖ Credentials verified at startup\n- ‚úÖ HTTP status codes korrekt\n- ‚úÖ Klaar voor STAP 3\n\n---\n\n## üìå FILES TO MODIFY\n\n1. **`src/solver/greedy_api.py`**\n   - Location: Solve endpoint (line ~50)\n   - Change: Error handling + HTTP status\n   - Priority: 1\n\n2. **`src/solver/greedy_engine.py`**\n   - Location 1: Init (line ~83)\n   - Change: Credentials validation\n   - Priority: 3\n   \n   - Location 2: Phase 4 (line ~480)\n   - Change: Enhanced logging\n   - Priority: 2\n\n---\n\n## üöÄ CONCLUSION\n\n### Current Status\n- ‚úÖ **STAP 1:** Environment variables VOLTOOID\n- ‚ùå **STAP 2:** Code fixes NIET BEGONNEN (maar gepland)\n- ‚è∏Ô∏è **STAP 3:** Wacht op STAP 2 completion\n\n### Why We're Not On STAP 3 Yet\n- Current code reports false success\n- Database write failures are invisible\n- Testing without fixes would be useless\n- Must fix root causes first\n\n### Next Step\n1. Download dit document\n2. Upload in nieuwe draad\n3. Execute STAP 2 code fixes\n4. Then proceed to STAP 3\n\n---\n\n**Document:** DRAAD 209 Evaluatie & STAP 2 Plan  \n**Status:** READY FOR NEXT THREAD  \n**Last Updated:** 18 December 2025, 19:00 CET\n"